---
title: "Group I: Informal Sensitivity - Almond Yields"
author: "Paloma Cartwright, Julia Parish, Quin Smith"
date: "2022/04/19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(janitor)
library(purrr)

options(scipen=999)
```


# Informal Sensitivity - Almond Yields

This environmental model and sensitivity analysis was completed as an assignment for the course, Environmental Data Science 230 | Environmental Science & Management: Modeling Environmental Systems. The goal of this assignment was to .... The source data and model design is based on research published in the paper, Impacts of future climate change on California perennial crop yields: Model projections with climate and crop uncertainties (Lobell 2006). 

### Load Functions

```{r}
source(here("R/almond_model.R"))
source(here("R/compute_NPV.R"))
source(here("R/compute_profit_fromanmly.R"))
source(here("R/almond_sensitivity.R"))
```

## Read in Climate Data 

```{r}
clim <- read.table(here("data/clim.txt"), header = TRUE) %>% 
  clean_names()
```

# Create Data Frame of Almond Prices 

This data was based off of the USDA Almond Forecast which can be found [here](https://www.nass.usda.gov/Statistics_by_State/California/Publications/Specialty_and_Other_Releases/Almond/Forecast/201005almpd.pdf). For the years 1989 - 1994, the almond price was not provided we used the average price from 1995 - 2010 as the value for the missing years. 

```{r}
#years 1989-2010
year <- c(1989, 1990, 1991, 1992, 1993, 1994, 1995, 
          1996, 1997, 1998, 1999, 2000, 2001, 2002, 
          2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010)

#$ per pound * 2000 = $ per ton
prices <- c(2.02, 2.02, 2.02, 2.02, 2.02, 2.02, 2.48, 
            2.08, 1.56, 1.41, 0.86, 0.97, 0.91, 1.11, 
            1.57, 2.21, 2.81, 2.06, 1.75, 1.45, 1.65, 1.79) * 2000

price_per_year <- data.frame(year, prices)
```

# Calculate Yield Anomaly 

## Subset the data

```{r}
#subset the clim data for monthly averages
clim_avg <- clim %>% 
  group_by(year, month) %>% 
  summarize(mean_temp = mean(tmin_c), 
            tot_precip = sum(precip)) %>% 
  filter(month %in% c(1, 2))

# create a variable for avg. February temp. data
Tn2 <- clim_avg %>% 
  group_by(year) %>% 
  mutate(Tn2 = case_when(month == 2 ~ mean_temp)) %>% 
  select(year, Tn2) %>% 
  drop_na()

# create a variable for avg. January precipitation data
P1 <- clim_avg %>% 
  group_by(year) %>% 
  mutate(P1 = case_when(month == 1 ~ tot_precip)) %>% 
  select(year, P1) %>% 
  drop_na

# create a variable combined temp and precip data
func_vars <- cbind(Tn2, P1 = P1$P1, price = price_per_year$prices)
```

## Run Almond Yield Model 

```{r}
#run almond_model() on subsetted clim data
almond_yield_anmly <- func_vars %>% 
  mutate(yield_anmly = almond_model(Tn2 = Tn2, P1 = P1))
  
```

## 1. Develop a profit model for almond yield

```{r}
profit <- compute_profit_fromanmly(anmly = almond_yield_anmly$yield_anmly, 
                                   year = almond_yield_anmly$year, 
                                   price = price_per_year$prices)
```


## 2. Conduct a simple informal sensitivity analysis of total almond yield profit using at least 2 parameters

```{r}
nsamples <- 100

#Tn2 sensitivity
Tn2_runif <- runif(n = nsamples, min = min(func_vars$Tn2), max = max(func_vars$Tn2))

results_Tn2 <- Tn2_runif %>% 
  map(~almond_model_test(df = func_vars, P1 = func_vars$P1, price = func_vars$price, Tn2 = .x))

tmp <- map_df(results_Tn2,`[`, c("profit")) 
Tn2_df <- data.frame(year = tmp$profit$year, 
                     netpre= tmp$profit$netpre)

#P1 sensitivity
P1_runif <- runif(n = nsamples, min = min(func_vars$P1), max = max(func_vars$P1))

results_P1 <- P1_runif %>% 
  map(~almond_model_test(df = func_vars, Tn2 = func_vars$Tn2, price = func_vars$price, P1 = .x))

tmp <- map_df(results_P1, `[`, c("profit"))
P1_df <- data.frame(year = tmp$profit$year, 
                     netpre= tmp$profit$netpre)

#price sensitivity
price_runif <- runif(n = nsamples, min = min(func_vars$price), max = max(func_vars$price))

results_price <- price_runif %>% 
  map(~almond_model_test(df = func_vars, P1 = func_vars$P1, Tn2 = func_vars$Tn2, price = .x))

tmp <- map_df(results_price, `[`, c("profit"))
price_df <- data.frame(year = tmp$profit$year, 
                     netpre= tmp$profit$netpre)
```


## 3. Create a single graph of the results



## 4. Output the graph as a stand alone image










## Summarize Results



## References

Lobell, D., Field, C., Nicholas, K., & Bonfils, C. (2006). Impacts of future climate change on California perennial crop yields: Model projections with climate and crop uncertainties. Agricultural and Forest Meteorology, 141, 208â€“218. https://doi.org/10.1016/j.agrformet.2006.10.006

Zhang, Z., Jin, Y., Chen, B., & Brown, P. (2019). California Almond Yield Prediction at the Orchard Level With a Machine Learning Approach. Frontiers in Plant Science, 10, 809. https://doi.org/10.3389/fpls.2019.00809

USDA/NASS, Pacific Regional Office. (2019). 2019 California Almond Forecast. USDA National Agricultural Statistics Service. www.nass.usda.gov/ca

## Repository

[Group I Github Repository](https://github.com/juliaparish/EDS230_EnviroModeling_AlmondModel) https://github.com/juliaparish/EDS230_EnviroModeling_AlmondModel