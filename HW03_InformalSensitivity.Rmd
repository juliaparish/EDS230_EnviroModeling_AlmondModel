---
title: "Group I: Informal Sensitivity - Almond Yields"
author: "Paloma Cartwright, Julia Parish, Quin Smith"
date: "2022/04/19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(janitor)
library(purrr)
library(RColorBrewer)
library(patchwork)

options(scipen=999)
```


# Informal Sensitivity - Almond Yields

This environmental model and sensitivity analysis was completed as an assignment for the course, Environmental Data Science 230 | Environmental Science & Management: Modeling Environmental Systems. The goal of this assignment was to develop a profit model for the California almond yield, conduct a simple informal sensitivity analysis, and graph analysis results. The source data and model design is based on research published in the paper, Impacts of future climate change on California perennial crop yields: Model projections with climate and crop uncertainties (Lobell 2006). 

### Load Functions

```{r}
source(here("R/almond_model.R"))
source(here("R/compute_NPV.R"))
source(here("R/compute_profit_fromanmly.R"))
source(here("R/almond_model_test.R"))
```

### Read in Climate Data 

```{r}
clim <- read.table(here("data/clim.txt"), header = TRUE) %>% 
  clean_names()
```

## Create Data Frame of Almond Prices 

This data was based off of the USDA Almond Forecast, which can be found [here](https://www.nass.usda.gov/Statistics_by_State/California/Publications/Specialty_and_Other_Releases/Almond/Forecast/201005almpd.pdf) (USDA/NASS 2019). For the years 1989 - 1994, the almond price was not provided we used the average price from 1995 - 2010 as the value for the missing years. 

```{r}
#years 1989-2010
year <- c(1989, 1990, 1991, 1992, 1993, 1994, 1995, 
          1996, 1997, 1998, 1999, 2000, 2001, 2002, 
          2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010)

#$ per pound * 2000 = $ per ton
prices <- c(2.02, 2.02, 2.02, 2.02, 2.02, 2.02, 2.48, 
            2.08, 1.56, 1.41, 0.86, 0.97, 0.91, 1.11, 
            1.57, 2.21, 2.81, 2.06, 1.75, 1.45, 1.65, 1.79) * 2000

price_per_year <- data.frame(year, prices)
```

\newpage

## Calculate Yield Anomaly 

### Subset the data

```{r}
#subset the clim data for monthly averages
clim_avg <- clim %>% 
  group_by(year, month) %>% 
  summarize(mean_temp = mean(tmin_c), 
            tot_precip = sum(precip)) %>% 
  filter(month %in% c(1, 2))

# create a variable for avg. February temp. data
Tn2 <- clim_avg %>% 
  group_by(year) %>% 
  mutate(Tn2 = case_when(month == 2 ~ mean_temp)) %>% 
  select(year, Tn2) %>% 
  drop_na()

# create a variable for avg. January precipitation data
P1 <- clim_avg %>% 
  group_by(year) %>% 
  mutate(P1 = case_when(month == 1 ~ tot_precip)) %>% 
  select(year, P1) %>% 
  drop_na

# create a variable combined temp and precip data and added price
func_vars <- cbind(Tn2, P1 = P1$P1, price = price_per_year$prices)
```

### Run Almond Yield Model 

```{r}
#run almond_model() on subsetted clim data
almond_yield_anmly <- func_vars %>% 
  mutate(yield_anmly = almond_model(Tn2 = Tn2, P1 = P1))
  
```

# Assignment 03 Responses

## 1. Develop a profit model for almond yield

```{r}
#run compute_profit_fromanmly() over the almond data
profit <- compute_profit_fromanmly(anmly = almond_yield_anmly$yield_anmly, 
                                   year = almond_yield_anmly$year, 
                                   price = price_per_year$prices)
```

### Profit model visualization

```{r}
# profit viz - geom_line or point, similar to last assignment - JULIA

```


## 2. Conduct a simple informal sensitivity analysis of total almond yield profit using at least 2 parameters

```{r}
nsamples <- 100

# test the sensitivity of model to each param (temp, precip)
#Tn2 sensitivity
#uniform random sample
Tn2_sample <- runif(n = nsamples, min = min(func_vars$Tn2), max = max(func_vars$Tn2))

#run almond_model_test() over the variables, using sample of Tn2
results_Tn2 <- Tn2_sample %>% 
  map(~almond_model_test(df = func_vars, P1 = func_vars$P1, price = func_vars$price, Tn2 = .x))

#create temp data structure from purrr results
tmpTn2 <- map_df(results_Tn2,`[`, c("profit"))

#create dataframe from temp results
Tn2_df <- data.frame(year = tmpTn2$profit$year, 
                     netpre= tmpTn2$profit$netpre)

#create temp data strucuture from purrr results for mean
tmpTn2mn <- map_df(results_Tn2,`[`, c("mean_netpre"))

#create dataframe from temp results
Tn2mn_df <- data.frame(Tn2 = Tn2_sample, mean_netpre = tmpTn2mn$mean_netpre)

#P1 sensitivity
#uniform random sample
P1_sample <- runif(n = nsamples, min = min(func_vars$P1), max = max(func_vars$P1))

#run almond_model_test() over the variables, using sample of P1
results_P1 <- P1_sample %>% 
  map(~almond_model_test(df = func_vars, Tn2 = func_vars$Tn2, price = func_vars$price, P1 = .x))

#create temp data structure from purrr results
tmpP1 <- map_df(results_P1, `[`, c("profit"))

#create dataframe from temp results
P1_df <- data.frame(year = tmpP1$profit$year, 
                     netpre= tmpP1$profit$netpre)

#create temp data strucuture from purrr results for mean
tmpP1mn <- map_df(results_P1,`[`, c("mean_netpre"))

#create dataframe from temp results
P1mn_df <- data.frame(P1 = P1_sample, mean_netpre = tmpP1mn$mean_netpre)

#price sensitivity
#uniform random sample
price_sample <- runif(n = nsamples, min = min(func_vars$price), max = max(func_vars$price))

#run almond_model_test() over the variables, using sample of price
results_price <- price_sample %>% 
  map(~almond_model_test(df = func_vars, P1 = func_vars$P1, Tn2 = func_vars$Tn2, price = .x))

#create temp data structure from purrr results
tmpprice <- map_df(results_price, `[`, c("profit"))

#create dataframe from temp results
price_df <- data.frame(year = tmpprice$profit$year, 
                     netpre= tmpprice$profit$netpre)

#create temp data strucuture from purrr results for mean
tmppricemn <- map_df(results_price,`[`, c("mean_netpre"))

#create dataframe from temp results
pricemn_df <- data.frame(price = price_sample, mean_netpre = tmppricemn$mean_netpre)
```


## 3. Create a single graph of the results

```{r, fig.cap = "Boxplot of almond prices"}
# unadjusted box plot
ggplot(price_df, 
       aes(x = as.factor(year), y = netpre, group=year)) +
  geom_boxplot(color = "gray61", fill = "navajowhite") +
  labs(title = "Almond Profit Anomaly",
       x="Year", y="Profit in current $",
       caption = "Data Sources: Lobell 2016, USDA/NASS 2019") +
  scale_y_continuous(labels=scales::dollar_format()) +
  theme_minimal()
```




```{r}
ggplot(price_df, 
       aes(x = as.factor(year), y = netpre, group = year)) +
  geom_point()

ggplot(pricemn_df, aes(x = price, y = mean_netpre)) +
  geom_point() +
  theme_bw()

ggplot(Tn2mn_df, aes(x = Tn2, y = mean_netpre)) +
  geom_point() +
  theme_bw()

ggplot(P1mn_df, aes(x = P1, y = mean_netpre)) +
  geom_point() +
  theme_bw()
```


## 4. Output the graph as a stand alone image

```{r}
# ggsave(filename,
#   plot = last_plot(),
#   device = NULL,
#   path = NULL,
#   scale = 1,
#   width = NA,
#   height = NA,
#   units = "cm",
#   dpi = 300,
# )
```




## Summarize Results



## References

Lobell, D., Field, C., Nicholas, K., & Bonfils, C. (2006). Impacts of future climate change on California perennial crop yields: Model projections with climate and crop uncertainties. Agricultural and Forest Meteorology, 141, 208â€“218. https://doi.org/10.1016/j.agrformet.2006.10.006

Zhang, Z., Jin, Y., Chen, B., & Brown, P. (2019). California Almond Yield Prediction at the Orchard Level With a Machine Learning Approach. Frontiers in Plant Science, 10, 809. https://doi.org/10.3389/fpls.2019.00809

USDA/NASS, Pacific Regional Office. (2019). 2019 California Almond Forecast. USDA National Agricultural Statistics Service. www.nass.usda.gov/ca

## Repository

[Group I Github Repository](https://github.com/juliaparish/EDS230_EnviroModeling_AlmondModel) https://github.com/juliaparish/EDS230_EnviroModeling_AlmondModel